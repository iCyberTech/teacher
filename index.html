<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Website</title>
  <style>
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .group {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      background-color: #f9f9f9;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    button {
      margin: 5px;
      padding: 5px 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Teacher Dashboard</h1>
  <button onclick="fetchAllGroups()">Load All Groups</button>
  <div id="groupsGrid" class="grid"></div>

  <div id="groupFormContainer" class="hidden">
    <h2>Create/Edit Group</h2>
    <form id="groupForm">
      <input type="text" id="groupName" placeholder="Group Name" required>
      <button type="submit">Save Group</button>
    </form>
  </div>

  <script type="module">
    // Import Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, setDoc, getDocs, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBxORm1Up_vSQHnT5WVTqP9I7HKWKsBBm4",
      authDomain: "school-mangement-8ca60.firebaseapp.com",
      projectId: "school-mangement-8ca60",
      storageBucket: "school-mangement-8ca60.firebasestorage.app",
      messagingSenderId: "313997383681",
      appId: "1:313997383681:web:7b1e55f6c036120c5fc800",
      measurementId: "G-P3JST7V88B"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Function to fetch all groups and display them in a grid
    window.fetchAllGroups = async function () {
      try {
        const querySnapshot = await getDocs(collection(db, 'groups'));
        const groupsGridDiv = document.getElementById('groupsGrid');
        groupsGridDiv.innerHTML = '';

        if (querySnapshot.empty) {
          groupsGridDiv.innerHTML = '<p>No groups found.</p>';
          return;
        }

        querySnapshot.forEach((groupDoc) => {
          const groupData = groupDoc.data();
          const groupId = groupDoc.id;

          // Create a group card
          const groupCard = document.createElement('div');
          groupCard.className = 'group';
          groupCard.innerHTML = `
            <h3>${groupData.name}</h3>
            <table>
              <thead>
                <tr>
                  <th>Student Name</th>
                  <th>Grade</th>
                </tr>
              </thead>
              <tbody id="students_${groupId}"></tbody>
            </table>
            <button onclick="openAddStudentsModal('${groupId}')">Add Students</button>
            <button onclick="openRemoveStudentsModal('${groupId}')">Remove Students</button>
          `;

          // Append the group card to the grid
          groupsGridDiv.appendChild(groupCard);

          // Load students for this group
          loadStudentsForGroup(groupId, groupData.students || []);
        });
      } catch (error) {
        console.error('Error fetching groups: ', error);
        alert('Error fetching groups. Please try again.');
      }
    };

    // Function to load students for a specific group
    async function loadStudentsForGroup(groupId, studentIds) {
      const studentsTbody = document.getElementById(`students_${groupId}`);
      studentsTbody.innerHTML = '';

      if (studentIds.length === 0) {
        studentsTbody.innerHTML = '<tr><td colspan="2">No students in this group.</td></tr>';
        return;
      }

      try {
        const studentsSnapshot = await getDocs(collection(db, 'students'));
        studentsSnapshot.forEach((studentDoc) => {
          if (studentIds.includes(studentDoc.id)) {
            const studentData = studentDoc.data();
            studentsTbody.innerHTML += `
              <tr>
                <td>${studentData.name}</td>
                <td>${studentData.grade}</td>
              </tr>
            `;
          }
        });
      } catch (error) {
        console.error('Error loading students: ', error);
      }
    }

    // Function to open the "Add Students" modal
    window.openAddStudentsModal = async function (groupId) {
      const groupDoc = await getDoc(doc(db, 'groups', groupId));
      const groupData = groupDoc.data();

      // Get all students
      const studentsSnapshot = await getDocs(collection(db, 'students'));
      let modalContent = `
        <h3>Add Students to ${groupData.name}</h3>
        <div id="availableStudents">
      `;

      studentsSnapshot.forEach((studentDoc) => {
        const studentData = studentDoc.data();
        const isInGroup = groupData.students && groupData.students.includes(studentDoc.id);

        if (!isInGroup) {
          modalContent += `
            <div>
              <input type="checkbox" id="add_student_${studentDoc.id}">
              <label for="add_student_${studentDoc.id}">${studentData.name}</label>
            </div>
          `;
        }
      });

      modalContent += `
        </div>
        <button onclick="addStudentsToGroup('${groupId}')">Add Selected Students</button>
      `;

      // Display the modal
      alert(modalContent); // Replace this with a proper modal implementation
    };

    // Function to add selected students to a group
    window.addStudentsToGroup = async function (groupId) {
      const checkboxes = document.querySelectorAll('#availableStudents input[type="checkbox"]');
      const selectedStudents = [];

      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          selectedStudents.push(checkbox.id.replace('add_student_', ''));
        }
      });

      try {
        await updateDoc(doc(db, 'groups', groupId), {
          students: arrayUnion(...selectedStudents)
        });
        alert('Students added successfully!');
        fetchAllGroups(); // Refresh the groups list
      } catch (error) {
        console.error('Error adding students: ', error);
        alert('Error adding students. Please try again.');
      }
    };

    // Function to open the "Remove Students" modal
    window.openRemoveStudentsModal = async function (groupId) {
      const groupDoc = await getDoc(doc(db, 'groups', groupId));
      const groupData = groupDoc.data();

      // Get students in the group
      let modalContent = `
        <h3>Remove Students from ${groupData.name}</h3>
        <div id="groupStudents">
      `;

      const studentsSnapshot = await getDocs(collection(db, 'students'));
      studentsSnapshot.forEach((studentDoc) => {
        if (groupData.students && groupData.students.includes(studentDoc.id)) {
          const studentData = studentDoc.data();
          modalContent += `
            <div>
              <input type="checkbox" id="remove_student_${studentDoc.id}">
              <label for="remove_student_${studentDoc.id}">${studentData.name}</label>
            </div>
          `;
        }
      });

      modalContent += `
        </div>
        <button onclick="removeStudentsFromGroup('${groupId}')">Remove Selected Students</button>
      `;

      // Display the modal
      alert(modalContent); // Replace this with a proper modal implementation
    };

    // Function to remove selected students from a group
    window.removeStudentsFromGroup = async function (groupId) {
      const checkboxes = document.querySelectorAll('#groupStudents input[type="checkbox"]');
      const selectedStudents = [];

      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          selectedStudents.push(checkbox.id.replace('remove_student_', ''));
        }
      });

      try {
        await updateDoc(doc(db, 'groups', groupId), {
          students: arrayRemove(...selectedStudents)
        });
        alert('Students removed successfully!');
        fetchAllGroups(); // Refresh the groups list
      } catch (error) {
        console.error('Error removing students: ', error);
        alert('Error removing students. Please try again.');
      }
    };
  </script>
</body>
</html>
