<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Website</title>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Teacher Dashboard</h1>
  <button onclick="fetchAllStudents()">Load All Students</button>
  <button onclick="fetchAllGroups()">Load All Groups</button>
  <div id="studentsList"></div>
  <div id="groupsList"></div>

  <div id="groupFormContainer" class="hidden">
    <h2>Create/Edit Group</h2>
    <form id="groupForm">
      <input type="text" id="groupName" placeholder="Group Name" required>
      <div id="groupStudents">
        <h3>Students in Group</h3>
        <div id="availableStudents"></div>
      </div>
      <button type="submit">Save Group</button>
    </form>
  </div>

  <script type="module">
    // Import Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, setDoc, getDocs, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBxORm1Up_vSQHnT5WVTqP9I7HKWKsBBm4",
      authDomain: "school-mangement-8ca60.firebaseapp.com",
      projectId: "school-mangement-8ca60",
      storageBucket: "school-mangement-8ca60.firebasestorage.app",
      messagingSenderId: "313997383681",
      appId: "1:313997383681:web:7b1e55f6c036120c5fc800",
      measurementId: "G-P3JST7V88B"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Function to fetch all students
    window.fetchAllStudents = async function () {
      try {
        const querySnapshot = await getDocs(collection(db, 'students'));
        const studentsListDiv = document.getElementById('studentsList');
        studentsListDiv.innerHTML = '<h2>Students List</h2>';

        if (querySnapshot.empty) {
          studentsListDiv.innerHTML += '<p>No students found.</p>';
          return;
        }

        let tableHTML = `
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Grade</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
        `;

        querySnapshot.forEach((doc) => {
          const studentData = doc.data();
          tableHTML += `
            <tr>
              <td>${studentData.name || 'N/A'}</td>
              <td>${studentData.grade || 'N/A'}</td>
              <td><button onclick="loadStudentData('${doc.id}')">Edit</button></td>
            </tr>
          `;
        });

        tableHTML += `
            </tbody>
          </table>
        `;

        studentsListDiv.innerHTML += tableHTML;
      } catch (error) {
        console.error('Error fetching students: ', error);
        alert('Error fetching students. Please try again.');
      }
    };

    // Function to fetch all groups
    window.fetchAllGroups = async function () {
      try {
        const querySnapshot = await getDocs(collection(db, 'groups'));
        const groupsListDiv = document.getElementById('groupsList');
        groupsListDiv.innerHTML = '<h2>Groups List</h2>';

        if (querySnapshot.empty) {
          groupsListDiv.innerHTML += '<p>No groups found.</p>';
          return;
        }

        let tableHTML = `
          <table>
            <thead>
              <tr>
                <th>Group Name</th>
                <th>Students</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
        `;

        querySnapshot.forEach((doc) => {
          const groupData = doc.data();
          tableHTML += `
            <tr>
              <td>${groupData.name || 'N/A'}</td>
              <td>${groupData.students ? groupData.students.join(', ') : 'No students'}</td>
              <td>
                <button onclick="editGroup('${doc.id}')">Edit</button>
                <button onclick="deleteGroup('${doc.id}')">Delete</button>
              </td>
            </tr>
          `;
        });

        tableHTML += `
            </tbody>
          </table>
        `;

        groupsListDiv.innerHTML += tableHTML;
      } catch (error) {
        console.error('Error fetching groups: ', error);
        alert('Error fetching groups. Please try again.');
      }
    };

    // Function to edit a group
    window.editGroup = async function (groupId) {
      try {
        const groupDoc = await getDoc(doc(db, 'groups', groupId));
        if (groupDoc.exists()) {
          const groupData = groupDoc.data();

          // Populate the form
          document.getElementById('groupName').value = groupData.name || '';

          // Load available students
          const studentsSnapshot = await getDocs(collection(db, 'students'));
          const availableStudentsDiv = document.getElementById('availableStudents');
          availableStudentsDiv.innerHTML = '';

          studentsSnapshot.forEach((studentDoc) => {
            const studentData = studentDoc.data();
            const isInGroup = groupData.students && groupData.students.includes(studentDoc.id);

            availableStudentsDiv.innerHTML += `
              <div>
                <input type="checkbox" id="student_${studentDoc.id}" ${isInGroup ? 'checked' : ''}>
                <label for="student_${studentDoc.id}">${studentData.name}</label>
              </div>
            `;
          });

          // Show the form
          document.getElementById('groupFormContainer').classList.remove('hidden');
        } else {
          alert('Group not found.');
        }
      } catch (error) {
        console.error('Error editing group: ', error);
        alert('Error editing group. Please try again.');
      }
    };

    // Function to delete a group
    window.deleteGroup = async function (groupId) {
      if (confirm('Are you sure you want to delete this group?')) {
        try {
          await deleteDoc(doc(db, 'groups', groupId));
          alert('Group deleted successfully!');
          fetchAllGroups(); // Refresh the groups list
        } catch (error) {
          console.error('Error deleting group: ', error);
          alert('Error deleting group. Please try again.');
        }
      }
    };

    // Submit group data
    const groupForm = document.getElementById('groupForm');
    groupForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const groupName = document.getElementById('groupName').value;

      // Get selected students
      const selectedStudents = [];
      const checkboxes = document.querySelectorAll('#availableStudents input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          selectedStudents.push(checkbox.id.replace('student_', ''));
        }
      });

      // Group data object
      const groupData = {
        name: groupName,
        students: selectedStudents
      };

      try {
        // Add or update group data
        const groupId = prompt('Enter Group ID (leave blank to add a new group):');
        if (groupId) {
          await setDoc(doc(db, 'groups', groupId), groupData);
          alert('Group updated successfully!');
        } else {
          const docRef = await addDoc(collection(db, 'groups'), groupData);
          alert('Group added with ID: ' + docRef.id);
        }
        groupForm.reset(); // Clear the form
        fetchAllGroups(); // Refresh the groups list
      } catch (error) {
        console.error('Error adding/updating group: ', error);
        alert('Error adding/updating group. Please try again.');
      }
    });
  </script>
</body>
</html>
